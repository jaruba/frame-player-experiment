
<html>
  <head>
    <title>Stream</title>
    <style>
        html, body, video {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
        }
    </style>
  </head>

  <body>
    <script src="./hls.js"></script>

    <center>
      <video id="video"></video>
    </center>

    <script>

        // get streaming url from querystring

        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        var streamUrl = getParameterByName('stream');

        // start video

        var video = document.getElementById('video');
        if (Hls.isSupported()) {
            // use HLS if supported
            var hls = new Hls({
                debug: true,
            });
            hls.loadSource(streamUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MEDIA_ATTACHED, function() {
                video.muted = false;
                video.play();
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // fallback to HTML5 video
            video.src = streamUrl;
            video.addEventListener('canplay', function() {
                video.play();
            });
        }

        // handle prop change messages for parent

        function sendBuffering() {
            window.parent.postMessage({ propName: 'buffering', propValue: video.readyState < video.HAVE_FUTURE_DATA }, '*');
        };
        function sendBuffered() {
            var time = video.currentTime !== null && isFinite(video.currentTime) ? video.currentTime : 0;
            for (var i = 0; i < video.buffered.length; i++) {
                if (video.buffered.start(i) <= time && time <= video.buffered.end(i)) {
                    window.parent.postMessage({ propName: 'buffered', propValue: Math.floor(video.buffered.end(i) * 1000) }, '*');
                    return;
                }
            }
            window.parent.postMessage({ propName: 'buffered', propValue: Math.floor(time * 1000) }, '*');
        }
        video.onpause = function() {
            window.parent.postMessage({ propName: 'paused', propValue: !!video.paused }, '*');
        };
        video.onplay = function() {
            window.parent.postMessage({ propName: 'paused', propValue: !!video.paused }, '*');
        };
        video.ontimeupdate = function() {
            var time = video.currentTime !== null && isFinite(video.currentTime) ? video.currentTime : 0;
            if (time) {
                window.parent.postMessage({ propName: 'time', propValue: Math.floor(time * 1000) }, '*');
            }
            sendBuffered()
        };
        var bufferingEvents = ['onwaiting', 'onseeking', 'onseeked', 'onstalled', 'onplaying', 'oncanplay', 'canplaythrough', 'onloadeddata']
        bufferingEvents.forEach(function(bufferEvent) {
            video[bufferEvent] = function() {
                sendBuffering()
                sendBuffered()
            };
        })
        video.ondurationchange = function() {
            window.parent.postMessage({ propName: 'duration', propValue: Math.floor(video.duration * 1000) }, '*');
        };
        video.onvolumechange = function() {
            window.parent.postMessage({ propName: 'volume', propValue: Math.floor(video.volume * 100) }, '*');
            window.parent.postMessage({ propName: 'muted', propValue: !!video.muted }, '*');
        };
        video.onratechange = function() {
            if (video.playbackRate === null || !isFinite(video.playbackRate)) {
                return null;
            }

            window.parent.postMessage({ propName: 'playbackSpeed', propValue: video.playbackRate }, '*');
        };


        // listen for set prop events from parent

        var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
        var eventer = window[eventMethod];
        var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

        eventer(messageEvent, function(e) {
            var key = e.message ? "message" : "data";
            var data = e[key];
            if ((data || {}).propName) {
                switch (data.propName) {
                    case 'paused': {
                        data.propValue ? video.pause() : video.play();

                        break;
                    }
                    case 'time': {
                        if (data.propValue !== null && isFinite(data.propValue)) {
                            video.currentTime = parseInt(data.propValue, 10) / 1000;
                        }

                        break;
                    }
                    case 'volume': {
                        if (data.propValue !== null && isFinite(data.propValue)) {
                            video.muted = false;
                            video.volume = Math.max(0, Math.min(100, parseInt(data.propValue, 10))) / 100;
                        }

                        break;
                    }
                    case 'muted': {
                        video.muted = !!data.propValue;
                        break;
                    }
                    case 'playbackSpeed': {
                        if (data.propValue !== null && isFinite(data.propValue)) {
                            video.playbackRate = parseFloat(data.propValue);
                        }

                        break;
                    }
                }
            }
        }, false);

    </script>
</body>
</html>